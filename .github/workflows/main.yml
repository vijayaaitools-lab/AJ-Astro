import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import fetch from "node-fetch";
import { readFileSync } from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(bodyParser.json());

// Load remedies
const remediesPath = path.join(__dirname, "data", "remedies.json");
let remedies = {};
try {
  remedies = JSON.parse(readFileSync(remediesPath, "utf-8"));
} catch (err) {
  console.error("âŒ remedies.json missing:", err);
}

// Panchang API
app.get("/api/panchang", (req, res) => {
  const { date, lat, lon } = req.query;
  if (!date || !lat || !lon) {
    return res.status(400).json({ error: "Missing date, lat, lon" });
  }
  res.json({
    date,
    location: { lat, lon },
    sunrise: "06:48",
    sunset: "17:29",
    tithi: "Shukla Panchami",
    nakshatra: "Mrigashirsha",
    yoga: "Shubh",
    karana: "Bava"
  });
});

// Daily Horoscope
app.post("/api/daily-horoscope", async (req, res) => {
  const { sign } = req.body;
  if (!sign) return res.status(400).json({ error: "Missing sign" });

  try {
    const response = await fetch(
      `https://aztro.sameerkumar.website/?sign=${sign}&day=today`,
      { method: "POST" }
    );
    const data = await response.json();
    res.json(data);
  } catch (err) {
    res.status(500).json({ error: "Aztro API error", details: err });
  }
});

// Numerology
app.get("/api/numerology", (req, res) => {
  const { name } = req.query;
  if (!name) return res.status(400).json({ error: "Missing name" });

  const number = name
    .toLowerCase()
    .replace(/[^a-z]/g, "")
    .split("")
    .reduce((acc, char) => acc + (char.charCodeAt(0) - 96), 0);

  const destiny = ((number - 1) % 9) + 1;

  res.json({ name, destinyNumber: destiny });
});

// Remedies API
app.get("/api/remedies", (req, res) => {
  res.json(remedies);
});

// Start Server
app.listen(3000, () => {
  console.log("ðŸš€ Server running on http://localhost:3000");
});
